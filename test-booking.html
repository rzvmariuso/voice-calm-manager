<!DOCTYPE html>
<html>
<head>
    <title>AI Booking Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 10px 0; }
        button:hover { background: #0056b3; }
        .result { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; white-space: pre-wrap; }
        .success { border-left: 4px solid #28a745; }
        .error { border-left: 4px solid #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ AI Booking Function Test</h1>
        <p>Teste die ai-booking Edge Function ohne Anruf</p>
        
        <button onclick="testBooking()">üìû Test Erfolgreiche Buchung</button>
        <button onclick="testFailedBooking()">‚ùå Test Fehlgeschlagene Buchung</button>
        
        <div id="result"></div>
    </div>

    <script>
        async function testBooking() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '‚è≥ Teste Buchung...';
            
            try {
                const testData = {
                    message: {
                        type: "end-of-call-report",
                        analysis: {
                            summary: "Max Mustermann called to book a massage appointment for Monday 10:30. The AI assistant successfully booked the appointment.",
                            successEvaluation: "true"
                        },
                        artifact: {
                            transcript: `AI: Hallo, Hier ist der Ai Assistent der Praxis. Gerne helfe ich Ihnen bei der Terminbuchung. Wie kann ich Ihnen helfen?
User: Hallo, ich m√∂chte einen Termin buchen. Mein Name ist Max Mustermann.
AI: Gerne kann ich einen Termin f√ºr Sie buchen, Herr Mustermann. Wie lautet Ihre Telefonnummer?
User: 01234567890
AI: Danke. Wann h√§tten Sie gerne einen Termin?
User: Montag um 10 Uhr 30 f√ºr eine Massage bitte.
AI: Perfekt. Lassen Sie mich das zusammenfassen: Max Mustermann, 01234567890, Montag 10:30 Uhr, Massage. Ist das korrekt?
User: Ja.
AI: Perfekt, ich werde Ihre Daten jetzt zur Buchung des Termins senden. Ihr Termin f√ºr eine Massage am Montag um 10:30 ist erfolgreich gebucht!`
                        }
                    },
                    call: {
                        customer: {
                            number: "+4901234567890"
                        },
                        assistant: {
                            metadata: {
                                practiceId: "8b4d340f-075e-494b-86d3-65742a33c07c"
                            }
                        }
                    }
                };

                const response = await fetch('https://jdbprivzprvpfoxrfyjy.supabase.co/functions/v1/ai-booking', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkYnByaXZ6cHJ2cGZveHJmeWp5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3ODE0NjgsImV4cCI6MjA3MjM1NzQ2OH0.rCjuQmuWSpychlhDOdpmmtMFwsyO2ab3x36FAS0NFNU'
                    },
                    body: JSON.stringify(testData)
                });

                const result = await response.json();
                
                resultDiv.className = 'result ' + (response.ok ? 'success' : 'error');
                resultDiv.innerHTML = `
Status: ${response.status}
Response: ${JSON.stringify(result, null, 2)}

${result.booking_confirmed ? '‚úÖ TERMIN ERFOLGREICH GEBUCHT!' : '‚ùå Keine Buchung erstellt'}
${result.appointment_id ? `Termin ID: ${result.appointment_id}` : ''}
                `;
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `‚ùå Fehler: ${error.message}`;
            }
        }

        async function testFailedBooking() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '‚è≥ Teste gescheiterte Buchung...';
            
            try {
                const testData = {
                    message: {
                        type: "end-of-call-report",
                        analysis: {
                            summary: "User called but hung up without completing booking.",
                            successEvaluation: "false"
                        },
                        artifact: {
                            transcript: `AI: Hallo, Hier ist der Ai Assistent der Praxis. Gerne helfe ich Ihnen bei der Terminbuchung. Wie kann ich Ihnen helfen?
User: Hallo, ich wollte... √§h... eigentlich nichts. Tsch√ºss.
AI: Gerne helfe ich Ihnen bei Fragen. Haben Sie einen sch√∂nen Tag!`
                        }
                    },
                    call: {
                        customer: {
                            number: "+4901234567890"
                        }
                    }
                };

                const response = await fetch('https://jdbprivzprvpfoxrfyjy.supabase.co/functions/v1/ai-booking', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkYnByaXZ6cHJ2cGZveHJmeWp5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3ODE0NjgsImV4cCI6MjA3MjM1NzQ2OH0.rCjuQmuWSpychlhDOdpmmtMFwsyO2ab3x36FAS0NFNU'
                    },
                    body: JSON.stringify(testData)
                });

                const result = await response.json();
                
                resultDiv.className = 'result ' + (response.ok ? 'success' : 'error');
                resultDiv.innerHTML = `
Status: ${response.status}
Response: ${JSON.stringify(result, null, 2)}

${!result.booking_confirmed ? '‚úÖ Korrekt - Keine Buchung erstellt' : '‚ùå Fehler - Termin wurde f√§lschlicherweise gebucht'}
                `;
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `‚ùå Fehler: ${error.message}`;
            }
        }
    </script>
</body>
</html>